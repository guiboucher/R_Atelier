---
title: "Calcul Age"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

```{r setup, include=FALSE, comment="#>"}
knitr::opts_chunk$set(echo = TRUE)

html_vspace <- function(px = 50) {
  cat(paste0('<div style="height: ', px, 'px;"></div>'))
}
```
```{css, echo=FALSE}
.textfont10 {font-size: 10px}
.textfont11 {font-size: 11px}
.textfont12 {font-size: 12px}  /*Par défaut*/ 
.textfont13 {font-size: 13px}
.textfont14 {font-size: 14px}
.textfont15 {font-size: 15px}
```


# Objectif
Trouver la meilleure méthode pour calculer l'âge.
Dans le cas où une personne serait née le 29 février, la méthode pourrait tout être bonne que l'anniversaire se fasse le 28 février ou le 1$^{er}$ mars lors des années non bissextiles. La méthode sera considérée comme bonne si elle est constante au fil des années.

```{r, results="asis", echo=FALSE}
html_vspace()
```

# Paramètres et librairies

```{r, message=FALSE, warning=FALSE}
library(data.table)
library(dplyr)
library(lubridate)
library(microbenchmark)
library(stringr)


# Performance
n_benchmark <- 10  # Nombre d'itérations
performance_nobs <- 1e2  # Nombre d'observations du tableau

# Taux de succès
tx_succ_date_fin <- "2000-12-31"  # Date de fin pour analyse des taux de succès
```

```{r, results="asis", echo=FALSE}
html_vspace()
```

# Méthodes
L'âge calculé devrait être de 10 ans.

## Diviser par 365.25
Calculer le nombre de jours entre la date de naissance et la date où l'on veut déterminer l'âge, puis diviser par `365.25`.
```{r}
naissance <- as_date("2001-01-01")
calcul_age <- as_date("2010-01-01")
as.integer(date_calcul - naissance) / 365.25
floor(as.integer(date_calcul - naissance) / 365.25)
```

```{r, results="asis", echo=FALSE}
html_vspace(10)
```

## Diviser par 365
Calculer le nombre de jours entre la date de naissance et la date où l'on veut déterminer l'âge, puis diviser par `365`.
```{r}
naissance <- as_date("2001-01-01")
calcul_age <- as_date("2010-01-01")
as.integer(date_calcul - naissance) / 365
floor(as.integer(date_calcul - naissance) / 365)
```

```{r, results="asis", echo=FALSE}
html_vspace(10)
```

## Diviser par 10000
Convertir une date `AAAA-MM-JJ` en un **nombre entier** au format `AAAAMMJJ`, puis diviser par 10000.

```{r}
date_naissance <- as_date("2001-06-15")
date_calcul <- as_date(paste0(2002:2011, "01-01"))
# Convertir en entier au format AAAAMMJJ
date_naissance <- as.integer(str_remove_all(date_naissance, "-"))
date_calcul <- as.integer(str_remove_all(date_calcul, "-"))
date_calcul - date_naissance
(date_calcul - date_naissance) / 10000
floor((date_calcul - date_naissance) / 10000)
```

Diviser par 10000 et prendre la valeur plancher fonctionnera toujours pour calculer l'âge. **Notez bien** qu'il est important de prendre la valeur plancher (`floor()`) parce que les décimales n'ont pas de sens.

```{r}
# Une journée
(20210101 - 20201231) / 10000  # 31 décembre au 1er janvier
(20210701 - 20210630) / 10000  # 30 juin au 1er juillet
```

Les valeurs `0.887` et `0.0071` démontre que les décimales de la méthode n'ont pas de sens, car les deux représentent une journée.

```{r, results="asis", echo=FALSE}
html_vspace(10)
```

## lubridate : year() + as.period() + interval()

Utiliser la date de naissance et la date de calcul de l'âge dans la fonction `interval()` et convertir en période et en année.

```{r}
date_naissance <- as_date("2001-06-15")
date_calcul <- as_date(paste0(2002:2011, "01-01"))
age <- year(as.period(interval(date_naissance, date_calcul)))
names(age) <- date_calcul
age
```

Bien que cette méthode semble parfaite et efficace, elle n'est pas constante dans la gestion des années bissextiles. Si l'anniversaire est le 29 février, l'anniversaire est parfois le 28 février, d'autres le 1$^{er}$ mars.
```{r}
date_naissance <- as_date("1980-02-29")
date_calcul <- as_date(paste0(c(2001:2010), "02-28"))
age <- floor(interval(date_naissance, date_calcul) / dyears(1))
age
```


```{r, results="asis", echo=FALSE}
html_vspace(10)
```

## Comparaison MOIS et JOUR
Calculer le nombre d'années entre la date de calcul et la date de naissance. Si la combinaison `mois-jour` de la date de calcul est plus petite que celle de la date de naissance soustraire 1 à la valeur précédemment calculée.  
Cette méthode considère que l'anniversaire d'une date de naissance le 29 février sera le 1$^{er}$ mars lors des années non bissextiles.

```{r, class.source="textfont11"}
date_calcul <- as_date(paste0(2002:2011, "01-01"))
age <- sapply(date_calcul, function(x) {
  date_naissance <- as_date("2001-06-15")
  age <- year(x) - year(date_naissance)  # Nombre d'années entre la date de calcul et la naissance
  if (month(x) < month(date_naissance) | (month(x) == month(date_naissance) & day(x) < day(date_naissance))) {
    # La date de naissance est le 15 juin. Soustraire 1 si la date est entre le 1er janvier et le 14 juin
    age <- age - 1
  }
  return(age)
})
names(age) <- date_calcul
age
```

```{r, results="asis", echo=FALSE}
html_vspace(10)
```

## lubridate : decimal_date()
Convertir les dates en années avec décimales et soustraire les deux valeurs en prenant la valeur plancher.
```{r}
date_naissance <- as_date("2001-06-15")
date_calcul <- as_date(paste0(2002:2011, "01-01"))
age <- decimal_date(date_calcul) - decimal_date(date_naissance)
names(age) <- date_calcul
age
floor(age)
```


```{r, results="asis", echo=FALSE}
html_vspace()
```


# Test de performance

```{r}
set.seed(42)
dates_naiss <- seq(as_date("1961-01-01"), as_date("1980-12-31"), by = 1)
dates_age <- seq(as_date("2001-01-01"), as_date("2021-12-31"), by = 1)
df <- tibble(  # Pour tests dplyr
  ID = 1:performance_nobs,
  DATE_NAISS = sample(dates_naiss, performance_nobs, replace = TRUE),
  DATE_CALCUL = sample(dates_age, performance_nobs, replace = TRUE)
)
dt <- as.data.table(df)
dt

df_36525 <- function(df) {
  df <- df %>% mutate(AGE = floor(as.integer(DATE_CALCUL - DATE_NAISS) / 365.25))
}
df_365 <- function(df) {
  df <- df %>% mutate(AGE = floor(as.integer(DATE_CALCUL - DATE_NAISS) / 365))
}
df_10k <- function(df) {
  df <- df %>%
    mutate(DATE_CALCUL = as.integer(str_remove_all(DATE_CALCUL, "-")),
           DATE_NAISS = as.integer(str_remove_all(DATE_NAISS, "-")),
           AGE = floor((DATE_CALCUL - DATE_NAISS )/ 10000))
}
df_interval <- function(df) {
  df <- df %>%
    mutate(AGE = year(as.period(interval(DATE_NAISS, DATE_CALCUL))))
}
df_moisjour <- function(df) {
  df <- df %>% mutate(
    AGE = if_else(month(DATE_CALCUL) < month(DATE_NAISS) |
                    (month(DATE_CALCUL) == month(DATE_NAISS) & day(DATE_CALCUL) < day(DATE_NAISS)),
                  year(DATE_CALCUL) - year(DATE_NAISS) - 1,
                  year(DATE_CALCUL) - year(DATE_NAISS))
  )
}
df_decimal <- function(df) {
  df <- df %>% mutate(AGE = floor(decimal_date(DATE_CALCUL) - decimal_date(DATE_NAISS)))
}
dt_36525 <- function(dt) {
  dt[, AGE := floor(as.integer(DATE_CALCUL - DATE_NAISS) / 365.25)]
}
dt_365 <- function(dt) {
  dt[, AGE := floor(as.integer(DATE_CALCUL - DATE_NAISS) / 365)]
}
dt_10k <- function(dt) {
  dt[, DATE_CALC := as.integer(str_remove_all(DATE_CALCUL, "-"))]
  dt[, DATE_NAIS := as.integer(str_remove_all(DATE_NAISS, "-"))]
  dt[, AGE := floor((DATE_CALC - DATE_NAIS) / 10000)]
}
dt_interval <- function(dt) {
  dt[, AGE :=  year(as.period(interval(DATE_NAISS, DATE_CALCUL)))]
}
dt_moisjour <- function(dt) {
  dt[, AGE := fcase(
    month(DATE_CALCUL) < month(DATE_NAISS)
      | (month(DATE_CALCUL) == month(DATE_NAISS) & day(DATE_CALCUL) < day(DATE_NAISS)),
      year(DATE_CALCUL) - year(DATE_NAISS) - 1,
    default = year(DATE_CALCUL) - year(DATE_NAISS)
  )]
}
dt_decimal <- function(dt) {
  dt[, AGE := floor(decimal_date(DATE_CALCUL) - decimal_date(DATE_NAISS))]
}

microbenchmark(
  df_36525 = df_36525(df),
  df_365 = df_365(df),
  df_10k = df_10k(df),
  df_interval = df_interval(df),
  df_moisjour = df_moisjour(df),
  df_decimal = df_decimal(df),
  dt_36525 = dt_36525(dt),
  dt_365 = dt_365(dt),
  dt_10k = dt_10k(dt),
  dt_interval = dt_interval(dt),
  dt_moisjour = dt_moisjour(dt),
  dt_decimal = dt_decimal(dt),
  times = n_benchmark
)
```


```{r, results="asis", echo=FALSE}
html_vspace()
```


# Taux de succès
Pour toutes les dates de naissance en 1980, calculer l'âge pour toutes les dates suivantes jusqu'en `r year(tx_succ_date_fin)`.  
La méthode `mois-jour` sera utilisée comme référence.
```{r}
vec_naiss <- seq(as_date("1980-01-01"), as_date("1980-12-31"), 1)
vec_calcul <- seq(as_date("1980-01-01"), as_date(tx_succ_date_fin), 1)
dt <- as.data.table(expand.grid(
  NAISS = vec_naiss,
  CALCUL = vec_calcul
))
dt <- dt[NAISS <= CALCUL]
setkey(dt)
dt
dt[, REF := fcase(
  month(CALCUL) < month(NAISS) | (month(CALCUL) == month(NAISS) & day(CALCUL) < day(NAISS)),
    year(CALCUL) - year(NAISS) - 1,
  default = year(CALCUL) - year(NAISS)
)]
dt[, m36525 := floor(as.integer(CALCUL - NAISS) / 365.25)]
dt[, m365 := floor(as.integer(CALCUL - NAISS) / 365)]
dt[, m10k := floor(
  (as.integer(str_remove_all(CALCUL, "-")) - as.integer(str_remove_all(NAISS, "-"))) / 10000
)]
dt[, mInt :=  year(as.period(interval(NAISS, CALCUL)))]
dt[, mDec := floor(decimal_date(CALCUL) - decimal_date(NAISS))]
dt[, tx36525 := fcase(m36525 == REF, 1, default = 0)]
dt[, tx365 := fcase(m365 == REF, 1, default = 0)]
dt[, tx10k := fcase(m10k == REF, 1, default = 0)]
dt[, txInt := fcase(mInt == REF, 1, default = 0)]
dt[, txDec := fcase(mDec == REF, 1, default = 0)]
dt[, .(Tx36525 = sum(tx36525) / .N,
       Tx365 = sum(tx365) / .N,
       Tx10k = sum(tx10k) / .N,
       TxInt = sum(txInt) / .N,
       TxDec = sum(txDec) / .N)]
```





















